<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Analysis Tool</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --secondary-color: #64748b;
            --secondary-hover: #475569;
            --danger-color: #ef4444;
            --danger-hover: #dc2626;
            
            /* Light Mode Defaults */
            --background-color: #f8fafc;
            --container-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --border-color: #e2e8f0;
            --input-bg: #ffffff;
            --section-title-bg: #f1f5f9;
            --disclaimer-bg: #fffbeb;
            --disclaimer-border: #fde68a;
            --disclaimer-text: #b45309;
            --modal-backdrop: rgba(0, 0, 0, 0.4);
        }

        [data-theme="dark"] {
            --background-color: #0f172a;
            --container-bg: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --input-bg: #334155;
            --section-title-bg: #334155;
            --disclaimer-bg: #4a2c0d;
            --disclaimer-border: #92400e;
            --disclaimer-text: #fde68a;
            --modal-backdrop: rgba(0, 0, 0, 0.6);
        }

        body {
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background-color: var(--background-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .main-wrapper {
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px 100px; /* Add padding to bottom for FAB */
        }
        h1, h2, h3, h4 {
            color: var(--text-primary);
            font-weight: 700;
        }
        .container {
            background-color: var(--container-bg);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }

        /* --- Floating Action Buttons --- */
        .fab-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }
        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--container-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.2s ease-in-out;
        }
        .fab:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
            background-color: var(--section-title-bg);
        }
        .fab svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        /* --- Language Modal --- */
        #language-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-backdrop);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #language-modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        #language-selector-container {
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        #language-modal-overlay.visible #language-selector-container {
            transform: scale(1);
        }
        .language-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        /* --- FIXED Language Button Style --- */
        .lang-button {
            padding: 12px 8px;
            background-color: var(--primary-color); /* Blue background for all */
            color: #ffffff; /* White text for all */
            border: 2px solid transparent; /* Transparent border for alignment */
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease-in-out;
        }
        .lang-button:hover {
            filter: brightness(1.15);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }
        .lang-button.active {
            border-color: var(--danger-color); /* Red outline for selected */
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.6);
        }


        .language-disclaimer {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-top: 25px;
            padding: 10px;
            background-color: var(--section-title-bg);
            border-radius: 8px;
        }
        
        .question-group { margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color); }
        .question-group:last-child { border-bottom: none; }
        .question-text { font-weight: 600; margin-bottom: 15px; font-size: 1.1em; display: flex; align-items: center; gap: 8px; }
        .options-group { display: flex; flex-wrap: wrap; justify-content: flex-start; }
        .options-group label { display: flex; align-items: center; margin: 5px 0; cursor: pointer; flex-basis: 100%; text-align: left; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); transition: background-color 0.2s, border-color 0.2s; }
        .options-group label:hover { background-color: rgba(59, 130, 246, 0.1); border-color: var(--primary-color); }
        input[type="radio"], input[type="checkbox"] { margin-right: 12px; accent-color: var(--primary-color); width: 1.2em; height: 1.2em; }
        input[type="text"].inline-input { flex-grow: 1; margin-left: 10px; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--input-bg); color: var(--text-primary); }
        select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--input-bg); font-size: 1em; color: var(--text-primary); }
        button { display: block; width: 100%; padding: 14px; background-image: linear-gradient(to right, #60a5fa, #3b82f6); color: white; border: none; border-radius: 8px; font-size: 1.1em; font-weight: 600; cursor: pointer; margin-top: 10px; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 15px -5px rgba(59, 130, 246, 0.5); }
        button:hover { transform: translateY(-2px); box-shadow: 0 7px 20px -5px rgba(59, 130, 246, 0.6); }
        .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 30px; }
        .secondary-button { background-image: none; background-color: var(--secondary-color); box-shadow: 0 4px 15px -5px rgba(100, 116, 139, 0.5); }
        .secondary-button:hover { background-color: var(--secondary-hover); box-shadow: 0 7px 20px -5px rgba(100, 116, 139, 0.6); }
        .delete-button { background-image: none; background-color: var(--danger-color); box-shadow: 0 4px 15px -5px rgba(239, 68, 68, 0.5); }
        .delete-button:hover { background-color: var(--danger-hover); box-shadow: 0 7px 20px -5px rgba(239, 68, 68, 0.6); }
        .hidden { display: none; }
        #results-container { margin-top: 30px; }
        .result-section { margin-bottom: 30px; }
        .result-section h3 { border-bottom: 2px solid var(--primary-color); padding-bottom: 8px; font-size: 1.4em; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid var(--border-color); padding: 12px; text-align: left; }
        th { background-color: var(--section-title-bg); }
        #progress-bar-container { width: 100%; background-color: var(--border-color); border-radius: 99px; margin-bottom: 20px; overflow: hidden; }
        #progress-bar { width: 0%; height: 12px; background-image: linear-gradient(to right, #60a5fa, #3b82f6); border-radius: 99px; transition: width 0.5s ease-in-out; }
        .section-title { background-color: var(--section-title-bg); padding: 15px; border-radius: 12px; margin: 20px 0; display: flex; align-items: center; gap: 10px; }
        .error-message { color: #991b1b; font-weight: 600; margin-top: 15px; padding: 12px; background-color: #fee2e2; border: 1px solid #fca5a5; border-radius: 8px; text-align: center; }
        .profile-section { border: 1px solid var(--border-color); padding: 20px; border-radius: 12px; margin-top: 20px; }
        .profile-section input[type="text"], .profile-section select, .profile-section textarea { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; font-size: 1em; background-color: var(--input-bg); color: var(--text-primary); }
        .existing-profile-controls { display: flex; gap: 10px; align-items: center; }
        .existing-profile-controls select { flex-grow: 1; }
        .existing-profile-controls button { flex-shrink: 0; width: auto; padding: 12px 18px; }
        .disclaimer { background-color: var(--disclaimer-bg); border: 1px solid var(--disclaimer-border); padding: 15px; border-radius: 12px; margin-top: 20px; margin-bottom: 20px; }
        .disclaimer h3 { margin-top: 0; color: var(--disclaimer-text); }
        .guidance-box { background-color: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        .guidance-box h4 { margin-top: 0; color: #1e40af; }
        [data-theme="dark"] .guidance-box h4 { color: #93c5fd; }
        #ai-guidance-section { background-color: rgba(14, 165, 233, 0.1); border: 1px solid rgba(14, 165, 233, 0.2); }
        #ai-guidance-section .ai-button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; position: relative; }
        .ai-disclaimer { font-size: 0.9em; color: var(--text-secondary); margin-top: 15px; }
        .resource-list li { margin-bottom: 10px; }
        .archetype-title { font-size: 1.8em; font-weight: 700; background: -webkit-linear-gradient(#60a5fa, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; }
        .about-button { background: none; border: none; color: var(--primary-color); font-weight: 600; cursor: pointer; text-align: center; width: 100%; margin-top: 20px; padding: 10px; box-shadow: none; }
        .about-button:hover { background-color: rgba(59, 130, 246, 0.1); transform: none; box-shadow: none; }
        .about-content { background-color: var(--section-title-bg); padding: 20px; border-radius: 12px; margin-top: 20px; }
        .tooltip { position: relative; display: inline-block; cursor: pointer; color: var(--text-secondary); border: 1px solid var(--text-secondary); border-radius: 50%; width: 18px; height: 18px; font-size: 12px; text-align: center; line-height: 16px; flex-shrink: 0; }
        .tooltip .tooltiptext { visibility: hidden; width: 220px; background-color: #1e293b; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; }
        [data-theme="dark"] .tooltip .tooltiptext { background-color: #f1f5f9; color: #1e293b; }
        .tooltip:hover .tooltiptext, .tooltip.active .tooltiptext { visibility: visible; opacity: 1; }
        #copy-tooltip { position: absolute; bottom: 110%; left: 25%; transform: translateX(-50%); background-color: var(--text-primary); color: var(--container-bg); padding: 8px 12px; border-radius: 6px; z-index: 1; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        #copy-tooltip.show { opacity: 1; }
        #infographic-container { border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; background-color: var(--background-color); }
        .infographic-title { font-size: 1.5em; font-weight: 700; margin-bottom: 20px; text-align: center; }
        .infographic-grid { display: grid; grid-template-columns: 1fr; gap: 30px; }
        @media (min-width: 640px) { .infographic-grid { grid-template-columns: 1fr 1fr; } }
        .infographic-section-title { font-size: 1.2em; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid var(--border-color); padding-bottom: 5px; }
        .bar-chart-container .bar-item { margin-bottom: 10px; font-size: 0.9em; }
        .bar-chart-container .bar-label { margin-bottom: 4px; display: flex; justify-content: space-between; }
        .bar-chart-container .bar-background { background-color: var(--border-color); border-radius: 4px; overflow: hidden; }
        .bar-chart-container .bar-foreground { height: 20px; border-radius: 4px; background-color: var(--primary-color); color: white; font-size: 12px; line-height: 20px; padding-left: 8px; transition: width 0.5s ease-in-out; white-space: nowrap; }
        .strengths-list { list-style-type: '✨'; padding-left: 20px; }
        .strengths-list li { margin-bottom: 10px; padding-left: 10px; }
        .archetype-infographic-box { background-color: rgba(14, 165, 233, 0.1); border-left: 4px solid #3b82f6; padding: 15px; border-radius: 8px; }
        .archetype-infographic-box h5 { margin-top: 0; font-size: 1.1em; color: #0c4a6e; }
        [data-theme="dark"] .archetype-infographic-box h5 { color: #7dd3fc; }
        .trait-interpretation { font-size: 0.85em; color: var(--text-secondary); }
        .trigger-warning-text { color: var(--danger-color); font-weight: 700; text-transform: uppercase; }
        
        /* Google Translate Override */
        .goog-te-banner-frame.skiptranslate { display: none !important; } 
        body { top: 0px !important; }
        #goog-gt-tt { display: none !important; }
    </style>
    <script type="text/javascript">
        // Function to initialize Google Translate, called by the script callback
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({pageLanguage: 'en', layout: google.translate.TranslateElement.InlineLayout.SIMPLE, autoDisplay: false}, 'google_translate_element');
        }
    </script>
</head>
<body>

<div id="language-modal-overlay">
    <div id="language-selector-container" class="container">
        <h2>Choose Your Language / अपनी भाषा चुनें</h2>
        <div id="language-grid" class="language-grid">
            <!-- Language buttons will be inserted here by JavaScript -->
        </div>
        <p class="language-disclaimer">Translations are powered by Google Translate and may not be 100% accurate. The original test is in English.</p>
    </div>
</div>

<div class="main-wrapper">
    <div class="container" id="main-container">
        <div id="google_translate_element" style="position: absolute; top: -9999px; left: -9999px;"></div>

        <div id="intro-section">
            <h1>Personal Analysis Tool</h1>
            <h2>Welcome</h2>
            <p>This tool uses scientifically-validated frameworks to help you build a comprehensive picture of your personality, strengths, and life experiences.</p>
            <p>The full questionnaire takes approximately 15-20 minutes to complete. Your progress is saved automatically, so you can close the window and resume at any time by loading your profile.</p>
            <div class="disclaimer">
                <h3>Please Note</h3>
                <p>This is a tool for self-reflection, not a diagnostic instrument. The results are for personal development and are not a substitute for professional psychological or medical advice. If you have concerns about your mental health, please speak with a qualified professional.</p>
            </div>
            <div class="profile-section">
                <h4>Create a New Profile</h4>
                <input type="text" id="profile-name-input" placeholder="Enter your name or an alias">
                <button onclick="handleNewProfile()">Start Fresh Test</button>
            </div>
            <div class="profile-section hidden" id="existing-profiles-section">
                <h4>Or, Select an Existing Profile</h4>
                <div class="existing-profile-controls">
                    <select id="profile-select"></select>
                    <button class="delete-button" onclick="handleDeleteProfile()" title="Delete selected profile">Delete</button>
                </div>
                <button onclick="handleLoadProfile()">Load Selected Profile</button>
            </div>
            <button class="about-button" id="about-button">About this Tool</button>
            <div class="about-content hidden" id="about-content">
                <h2>About This Tool</h2>
                <p><strong>Our Core Idea:</strong> To create a scientifically rigorous starting point for anyone seeking a more satisfying and impactful life.</p>
                <p>This tool was designed to bridge the gap between self-knowledge and real-world action. It analyzes your core strengths and personality, acknowledges the reality of your life experiences, and uses this complete picture to help you find your unique place in the world.</p>
                <h4>Scientific Foundations</h4>
                <p>The questionnaires used in this tool are based on established, peer-reviewed psychological frameworks:</p>
                <ul>
                    <li><strong>The Big Five (OCEAN):</strong> The most widely accepted scientific model of personality. <a href="https://www.apa.org/pubs/journals/features/psp-59-6-1216.pdf" target="_blank" rel="noopener noreferrer">Learn More (APA)</a>.</li>
                    <li><strong>VIA Character Strengths:</strong> A framework of 24 universal positive traits. <a href="https://www.viacharacter.org/research/findings" target="_blank" rel="noopener noreferrer">Learn More (VIA Institute)</a>.</li>
                    <li><strong>Adverse Childhood Experiences (ACEs):</strong> Based on the landmark CDC-Kaiser Permanente study. <a href="https://www.cdc.gov/violenceprevention/aces/index.html" target="_blank" rel="noopener noreferrer">Learn More (CDC)</a>.</li>
                </ul>
                <h4>Your Privacy</h4>
                <p>All the data you enter is stored locally in your browser and is never sent to a server. When you request an AI analysis, only the necessary, anonymized data is copied to your clipboard for you to share with the AI of your choice.</p>
                <p><strong>Disclaimer:</strong> This is just a tool, not a definitive guide to life. Think of it as a compass, not a map. The journey is still yours to take.</p>
            </div>
        </div>
        <div id="load-profile-options-section" class="hidden">
             <h2 id="welcome-back-name"></h2>
             <div id="load-options-content"></div>
        </div>
        <div id="questionnaire-section" class="hidden">
            <h2 id="profile-display-name"></h2>
            <div class="guidance-box">
                <h4>A Quick Note on Answering</h4>
                <p>For each statement, please pick the single best answer that describes you. This helps us understand where you fall on a spectrum of traits, giving a more nuanced picture than simple yes-or-no boxes.</p>
            </div>
            <div id="progress-bar-container">
                <div id="progress-bar"></div>
            </div>
            <form id="unified-questionnaire">
                <!-- Questions will be loaded here by JavaScript -->
            </form>
            <div id="error-message" class="error-message hidden">Please answer all questions on this page before proceeding.</div>
            <div class="button-group" id="nav-button-group">
                <button id="prev-button" class="secondary-button hidden" onclick="previousSection()">Previous</button>
                <button id="next-button" onclick="nextSection()">Next</button>
            </div>
        </div>
        <div id="results-container" class="hidden">
            <h2>Your Personalized Report for <span id="results-profile-name"></span></h2>
            <div id="infographic-container" class="result-section"></div>
            <div id="archetype-section" class="result-section"></div>
            <div id="via-strengths-results" class="result-section"></div>
            <div id="ace-results" class="result-section"></div>
            <div id="health-results" class="result-section"></div>
            <div id="ai-guidance-section" class="result-section profile-section"></div>
            <div id="final-guidance" class="result-section"></div>
            <button onclick="returnToIntro()">Back to Profiles</button>
        </div>
    </div>
</div>

<div class="fab-container">
    <button class="fab" id="language-toggle" title="Change Language">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>
    </button>
    <button class="fab" id="theme-toggle" title="Toggle Dark Mode">
        <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
        <svg id="theme-icon-moon" class="hidden" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
    </button>
</div>

<script>
// Using a self-executing function to avoid polluting the global scope
(function() {
// Data for all questionnaire sections
const questions = [
    { section: "Demo", title: "Section 1: About You (Optional)", disclaimer: `<div class="disclaimer"><p>This first section is optional, but helps add valuable context to your final report. Please feel free to skip it.</p></div>`, items: [ { id: 'age', text: 'What is your age range?', type: 'select', options: ['Prefer not to say', 'Under 18', '18-24', '25-34', '35-44', '45-54', '55-64', '65+'] }, { id: 'gender', text: 'What is your gender?', type: 'select', options: ['Prefer not to say', 'Male', 'Female', 'Other'] }, { id: 'country', text: 'What is your country of residence?', type: 'select', options: ['Prefer not to say', 'India', 'United States', 'United Kingdom', 'Canada', 'Australia', 'Germany', 'Other'] }, { id: 'stage', text: 'Which of these best describes your current stage in life?', type: 'select', options: ['Prefer not to say', 'Primary/Secondary School Student', 'University/College Student', 'Working Professional (Early Career)', 'Working Professional (Mid/Late Career)', 'Career Changer', 'Retired', 'Not currently in education or workforce'] } ] },
    { section: "Health", title: "Section 2: Health & Abilities (Optional)", tooltip: "This information helps tailor suggestions to be more realistic and suitable for your circumstances.", disclaimer: `<div class="disclaimer"><h3>This Section is Optional</h3><p>Please skip this section if it is not relevant to you. Answering these questions helps provide a more complete picture, allowing the AI analysis to offer suggestions (for careers or hobbies) that are more suitable and accommodating to your real-life circumstances. This is not for diagnosis, but for personalization.</p></div>`, scale: ["Yes", "No"], items: [ { id: 'mobility', text: 'Do you have a condition that significantly impacts your mobility (e.g., ability to walk, stand for long periods, or use your hands)?' }, { id: 'chronic', text: 'Do you live with a chronic health condition that requires ongoing management (e.g., diabetes, hypertension, autoimmune disorders)?' }, { id: 'sensory', text: 'Do you have a significant sensory impairment (e.g., related to vision or hearing)?' }, { id: 'neuro', text: 'Do you identify as having a neurodevelopmental or mental health condition (e.g., ADHD, Autism Spectrum, Depression, Anxiety)?' }, { id: 'other', text: 'Do you have another disability, ailment, or condition not listed above that impacts your daily life?', hasOther: true } ] },
    { section: "Work", title: "Section 3: Work & Lifestyle Preferences (Optional)", disclaimer: `<div class="disclaimer"><h3>This Section is Optional</h3><p>Please skip this section if it is not relevant to you (e.g., if you are a student or retired). These questions help tailor career suggestions to your personal style and values.</p></div>`, items: [ { id: 'environment', text: 'I work best in...', type: 'radio', scale: ['A highly structured environment with clear rules', 'A flexible environment with a lot of autonomy', 'A highly collaborative and social team environment', 'A quiet, independent environment'] }, { id: 'role', text: 'In a team project, I naturally prefer to...', type: 'radio', scale: ['Lead, organize, and delegate tasks', 'Brainstorm ideas and conduct research', 'Support team members and ensure harmony', 'Focus on completing my specific part to a high standard'] }, { id: 'driver', text: 'My single most important career driver is...', type: 'radio', scale: ['Financial security and high earning potential', 'Making a tangible, positive impact', 'Intellectual challenge and continuous learning', 'Work-life balance and personal well-being', 'Creative expression and freedom'] } ] },
    { section: "A", title: "Section 4: Your Personality Blueprint (Big Five)", tooltip: "The Big Five (OCEAN) is the most widely accepted scientific model of personality, measuring five core dimensions.", instructions: "Read each statement carefully and rate how well it describes you.", scale: ["Very Inaccurate", "Moderately Inaccurate", "Neither Accurate nor Inaccurate", "Moderately Accurate", "Very Accurate"], items: [ { text: "I have a rich vocabulary.", trait: "O", tooltip: "Meaning: I know and use a wide range of words." }, { text: "I have a vivid imagination.", trait: "O" }, { text: "I have excellent ideas.", trait: "O" }, { text: "I am quick to understand things.", trait: "O" }, { text: "I use difficult words.", trait: "O" }, { text: "I spend time reflecting on things.", trait: "O" }, { text: "I am full of ideas.", trait: "O" }, { text: "I am not interested in abstract ideas.", trait: "O", reverse: true }, { text: "I do not have a good imagination.", trait: "O", reverse: true }, { text: "I have difficulty understanding abstract ideas.", trait: "O", reverse: true }, { text: "I am always prepared.", trait: "C" }, { text: "I pay attention to details.", trait: "C" }, { text: "I get chores done right away.", trait: "C" }, { text: "I like order.", trait: "C" }, { text: "I follow a schedule.", trait: "C" }, { text: "I am exacting in my work.", trait: "C" }, { text: "I leave my belongings around.", trait: "C", reverse: true }, { text: "I make a mess of things.", trait: "C", reverse: true }, { text: "I often forget to put things back in their proper place.", trait: "C", reverse: true }, { text: "I shirk my duties.", trait: "C", reverse: true, tooltip: "Meaning: I avoid or neglect my responsibilities." }, { text: "I am the life of the party.", trait: "E" }, { text: "I don't mind being the center of attention.", trait: "E" }, { text: "I feel comfortable around people.", trait: "E" }, { text: "I start conversations.", trait: "E" }, { text: "I talk to a lot of different people at parties.", trait: "E" }, { text: "I don't talk a lot.", trait: "E", reverse: true }, { text: "I keep in the background.", trait: "E", reverse: true }, { text: "I have little to say.", trait: "E", reverse: true }, { text: "I don't like to draw attention to myself.", trait: "E", reverse: true }, { text: "I am quiet around strangers.", trait: "E", reverse: true }, { text: "I am interested in people.", trait: "A" }, { text: "I sympathize with others' feelings.", trait: "A" }, { text: "I have a soft heart.", trait: "A", tooltip: "Meaning: I am compassionate and easily moved by others' feelings." }, { text: "I take time out for others.", trait: "A" }, { text: "I feel others' emotions.", trait: "A" }, { text: "I make people feel at ease.", trait: "A" }, { text: "I am not really interested in others.", trait: "A", reverse: true }, { text: "I insult people.", trait: "A", reverse: true }, { text: "I am not interested in other people's problems.", trait: "A", reverse: true }, { text: "I feel little concern for others.", trait: "A", reverse: true }, { text: "I am easily disturbed.", trait: "N" }, { text: "I change my mood a lot.", trait: "N" }, { text: "I get irritated easily.", trait: "N" }, { text: "I get stressed out easily.", trait: "N" }, { text: "I get upset easily.", trait: "N" }, { text: "I have frequent mood swings.", trait: "N" }, { text: "I often feel blue.", trait: "N", tooltip: "Meaning: To feel sad or depressed." }, { text: "I worry about things.", trait: "N" }, { text: "I am relaxed most of the time.", trait: "N", reverse: true }, { text: "I seldom feel blue.", trait: "N", reverse: true } ] },
    { section: "B", title: "Section 5: Your Character Strengths (VIA)", tooltip: "The VIA Inventory identifies 24 universal character strengths. Your top-rated strengths are your greatest assets.", instructions: "For each of the following strengths, please rate the degree to which the statement is 'like you'.", scale: ["Very much unlike me", "Unlike me", "Neutral", "Like me", "Very much like me"], items: [ { text: "I am good at coming up with new and different ways to do things.", strength: "Creativity" }, { text: "I am always asking questions and want to explore and discover.", strength: "Curiosity" }, { text: "I think things through and examine them from all sides; I don't jump to conclusions.", strength: "Judgment" }, { text: "I love learning new things, whether in a class or on my own.", strength: "Love of Learning" }, { text: "People I know consider me wise and often seek my advice.", strength: "Perspective" }, { text: "I am a courageous person who does not shrink from threat, challenge, difficulty, or pain.", strength: "Bravery" }, { text: "I work hard to finish what I start. I do not get distracted when I work.", strength: "Perseverance" }, { text: "I live my life in a genuine and authentic way; I am a down-to-earth person.", strength: "Honesty" }, { text: "I approach life with excitement and energy; I feel alive and activated.", strength: "Zest" }, { text: "I am good at valuing close relationships with others, and people feel warmth and affection from me.", strength: "Love" }, { text: "I am kind and generous to others, and I am never too busy to do a favor.", strength: "Kindness" }, { text: "I am aware of the motives and feelings of other people and myself.", strength: "Social Intelligence" }, { text: "I am a good teammate; I am loyal and dedicated to the groups I belong to.", strength: "Teamwork" }, { text: "Treating all people fairly is one of my abiding principles.", strength: "Fairness" }, { text: "I excel at encouraging a group to get things done and maintaining good relations within the group.", strength: "Leadership" }, { text: "I am a forgiving person. I always give people a second chance.", strength: "Forgiveness" }, { text: "I do not seek the spotlight; I prefer to let my accomplishments speak for themselves.", strength: "Humility" }, { text: "I am a careful person. I do not say or do things that I might later regret.", strength: "Prudence" }, { text: "I am a disciplined person. I can regulate what I feel and do.", strength: "Self-Regulation" }, { text: "I notice and appreciate beauty, excellence, and skilled performance in all domains of life.", strength: "Appreciation of Beauty & Excellence" }, { text: "I am aware of the good things that happen to me, and I never take them for granted.", strength: "Gratitude" }, { text: "I expect the best in the future, and I work to achieve it.", strength: "Hope" }, { text: "I like to laugh and tease. Bringing smiles to other people is important to me.", strength: "Humor" }, { text: "My beliefs about the meaning of life shape my actions. I have a sense of purpose.", strength: "Spirituality" } ] },
    { section: "C", title: "Section 6: Upbringing & Life Experiences (Optional)", tooltip: "This section is based on the Adverse Childhood Experiences (ACEs) study, a major public health study linking early experiences to adult well-being.", disclaimer: ` <div class="disclaimer"> <h3>This Section is Optional</h3> <p><span class="trigger-warning-text">TRIGGER WARNING:</span> This section contains questions about potentially traumatic childhood experiences that may be distressing. Please skip this section if it is not relevant to you or if you do not feel comfortable answering.</p> <p>The following questions are based on the Adverse Childhood Experiences (ACEs) study. They ask about potentially difficult or stressful experiences before the age of 18.</p> <ul> <li><strong>This is for self-reflection only and is NOT a diagnostic tool.</strong></li> <li>Answering these questions can be emotionally difficult. If you feel uncomfortable at any point, please use the "Skip this Section" button below.</li> </ul> <p><strong>If you have concerns about your mental health, please speak with a professional.</strong></p> </div> `, scale: ["Yes", "No"], items: [ { text: "Did a parent or other adult in the household often swear at you, insult you, put you down, or humiliate you?" }, { text: "Did a parent or other adult in the household often push, grab, slap, or throw something at you? Or ever hit you so hard that you had marks or were injured?" }, { text: "Did an adult or person at least 5 years older than you ever touch or fondle you or have you touch their body in a sexual way? Or attempt or actually have oral, anal, or vaginal intercourse with you?" }, { text: "Did you often feel that no one in your family loved you or thought you were important or special? Or that your family didn't look out for each other?" }, { text: "Did you often feel that you didn't have enough to eat, had to wear dirty clothes, or had no one to protect you? Or were your parents too drunk or high to take care of you?" }, { text: "Were your parents ever separated or divorced?" }, { text: "Was your mother or stepmother often pushed, grabbed, slapped, or had something thrown at her? Or ever repeatedly hit over a period of time? Or ever threatened with a gun or knife?" }, { text: "Did you live with anyone who was a problem drinker or alcoholic, or who used street drugs?" }, { text: "Was a household member depressed or mentally ill, or did a household member attempt suicide?" }, { text: "Did a household member go to prison?" } ] },
    { section: "D", title: "Section 7: Financial & Career Planning (Optional)", id: "careerPlanning", tooltip: "Answering these questions helps the AI provide more realistic and relevant career suggestions based on your real-world circumstances.", disclaimer: `<div class="disclaimer"><h3>This Section is Optional</h3><p>Please skip this section if it is not relevant to you. These questions help tailor career suggestions to your current real-world situation.</p></div>`, items: [ { text: "How important is it for you to start earning a stable, full-time salary within the next 1-2 years?", id: "incomeUrgency", type: 'radio', scale: ["Crucial", "Important", "Flexible", "Not a priority"] }, { text: "How comfortable are you with a career path that requires significant further financial investment (e.g., another expensive degree, years of low-paid training) before seeing a high return?", id: "investmentTolerance", type: 'radio', scale: ["Very Uncomfortable", "Somewhat Uncomfortable", "Neutral", "Comfortable"] } ] },
    { section: "E", title: "Section 7: Retirement Lifestyle & Finances (Optional)", id: "retirementPlanning", tooltip: "Answering these questions helps the AI provide more realistic and relevant suggestions for activities and hobbies.", disclaimer: `<div class="disclaimer"><h3>This Section is Optional</h3><p>Please skip this section if it is not relevant to you. These questions help tailor hobby and activity suggestions to your personal situation.</p></div>`, items: [ { text: "What is your approximate monthly budget for hobbies and leisure activities?", id: "hobbyBudget", type: 'radio', scale: ["Very limited (focus on free activities)", "Modest (up to a few thousand rupees / ~$50)", "Comfortable (can invest in equipment/classes)", "Very flexible"] }, { text: "In retirement, how physically active do you want to be?", id: "activityLevel", type: 'radio', scale: ["Mainly sedentary (e.g., reading, board games)", "Lightly active (e.g., walking, gardening)", "Moderately active (e.g., yoga, swimming)", "Very active (e.g., hiking, sports)"] }, { text: "How important is social engagement in your ideal retirement activities?", id: "socialNeed", type: 'radio', scale: ["I prefer solitary activities", "I enjoy small groups or one-on-one", "I thrive in large, social group settings"] } ] }
];

let currentSectionIndex = 0;
let userAnswers = {};
let currentProfileName = '';
let questionFlow = [];

// --- Theme & Language Management ---
const languages = { 'en': 'English', 'es': 'Español', 'fr': 'Français', 'de': 'Deutsch', 'hi': 'हिन्दी', 'bn': 'বাংলা', 'ta': 'தமிழ்', 'te': 'తెలుగు', 'mr': 'मराठी', 'gu': 'ગુજરાતી', 'kn': 'ಕನ್ನಡ', 'ml': 'മലയാളം', 'pa': 'ਪੰਜਾਬੀ', 'zh-CN': '中文 (简体)', 'ja': '日本語', 'ru': 'Русский', 'ar': 'العربية' };

// --- FIXED: Reworked Language Switching Logic using Cookies (more reliable) ---
function setCookie(key, value, days) {
    let expires = "";
    if (days) {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        expires = "; expires=" + date.toUTCString();
    }
    // Set cookie for the root path to ensure it's effective everywhere
    document.cookie = key + "=" + (value || "") + expires + "; path=/";
}

function changeLanguage(langCode) {
    // Save the user's choice to local storage for highlighting the button
    localStorage.setItem('selectedLanguage', langCode);
    
    // Use the reliable cookie method to trigger Google Translate
    setCookie('googtrans', '/en/' + langCode, 1);
    
    // Reload the page to apply the translation
    location.reload();
}

// This function now just highlights the active button based on localStorage
function updateActiveLanguageButton() {
    const selectedLang = localStorage.getItem('selectedLanguage') || 'en';
    document.querySelectorAll('.lang-button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.langCode === selectedLang) {
            btn.classList.add('active');
        }
    });
}

function populateLanguageSelector() {
    const grid = document.getElementById('language-grid');
    grid.innerHTML = '';
    for (const code in languages) {
        const button = document.createElement('button');
        button.className = 'lang-button';
        button.textContent = languages[code];
        button.dataset.langCode = code;
        button.onclick = () => changeLanguage(code);
        grid.appendChild(button);
    }
    // After creating the buttons, highlight the active one
    updateActiveLanguageButton();
}

function applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
    const sunIcon = document.getElementById('theme-icon-sun');
    const moonIcon = document.getElementById('theme-icon-moon');
    if (theme === 'dark') {
        sunIcon.classList.add('hidden');
        moonIcon.classList.remove('hidden');
    } else {
        sunIcon.classList.remove('hidden');
        moonIcon.classList.add('hidden');
    }
}

function toggleTheme() {
    const currentTheme = localStorage.getItem('theme') || 'light';
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    applyTheme(newTheme);
}

function initializeTheme() {
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (savedTheme) {
        applyTheme(savedTheme);
    } else if (prefersDark) {
        applyTheme('dark');
    } else {
        applyTheme('light');
    }
}

function toggleLanguageModal() {
    const modal = document.getElementById('language-modal-overlay');
    modal.classList.toggle('visible');
}


// --- Profile Management & App State ---
function getAllProfiles() {
    const profiles = localStorage.getItem('allUserProfiles');
    if (!profiles) return {};
    try { return JSON.parse(profiles); } catch (e) { return {}; }
}

function saveAllProfiles(profiles) {
    localStorage.setItem('allUserProfiles', JSON.stringify(profiles));
}

function initializeProfileView() {
    const allProfiles = getAllProfiles();
    const profileNames = Object.keys(allProfiles);
    const selectElement = document.getElementById('profile-select');
    const existingProfilesSection = document.getElementById('existing-profiles-section');
    if (profileNames.length > 0) {
        selectElement.innerHTML = profileNames.map(name => `<option value="${name}">${name}</option>`).join('');
        existingProfilesSection.classList.remove('hidden');
    } else {
        existingProfilesSection.classList.add('hidden');
    }
}

window.handleNewProfile = function() {
    const nameInput = document.getElementById('profile-name-input');
    const name = nameInput.value.trim();
    if (!name) { alert("Please enter a name or alias."); return; }
    const allProfiles = getAllProfiles();
    if (allProfiles[name] && !confirm(`A profile named "${name}" already exists. Overwrite?`)) return;
    currentProfileName = name;
    userAnswers = {};
    saveCurrentAnswers();
    startQuestionnaire('fresh');
}

window.handleLoadProfile = function() {
    const selectElement = document.getElementById('profile-select');
    const name = selectElement.value;
    if (!name) { alert("Please select a profile to load."); return; }
    const allProfiles = getAllProfiles();
    currentProfileName = name;
    userAnswers = allProfiles[name] || {};
    document.getElementById('intro-section').classList.add('hidden');
    document.getElementById('load-profile-options-section').classList.remove('hidden');
    document.getElementById('welcome-back-name').textContent = `Welcome Back, ${currentProfileName}`;
    analyzeProfileAndShowOptions();
}

window.handleDeleteProfile = function() {
    const selectElement = document.getElementById('profile-select');
    const name = selectElement.value;
    if (!name) { alert("Please select a profile to delete."); return; }
    if (confirm(`Are you sure you want to permanently delete the profile for "${name}"?`)) {
        const allProfiles = getAllProfiles();
        delete allProfiles[name];
        saveAllProfiles(allProfiles);
        initializeProfileView();
    }
}

function analyzeProfileAndShowOptions() {
    const mandatorySections = questions.filter(q => q.section === 'A' || q.section === 'B');
    let totalMandatory = mandatorySections.reduce((sum, s) => sum + s.items.length, 0);
    let answeredMandatory = mandatorySections.reduce((sum, s) => {
        return sum + s.items.filter((item, i) => userAnswers[`s${s.section}_q${i}`]).length;
    }, 0);
    const incompleteMandatory = answeredMandatory < totalMandatory;
    const skippedOptional = questions.filter(q => !['A', 'B'].includes(q.section)).some(s => s.items.some((item, i) => userAnswers[item.id ? `s${s.section}_${item.id}` : `s${s.section}_q${i}`] === 'skipped'));
    const contentEl = document.getElementById('load-options-content');
    let html = '';
    if (incompleteMandatory) {
        html = `<p>You haven't completed the core sections. It's recommended to complete these for an accurate report.</p>
                <div class="button-group"><button onclick="startQuestionnaire('complete_missing')">Complete My Profile</button><button class="secondary-button" onclick="calculateResults()">See Partial Results</button></div>`;
    } else if (skippedOptional) {
        html = `<p>You've completed the core sections, but skipped some optional ones. Answering them can provide a more personalized analysis.</p>
                <div class="button-group"><button onclick="startQuestionnaire('complete_missing')">Fill Optional Sections</button><button class="secondary-button" onclick="startQuestionnaire('review')">Review My Answers</button></div>
                <button onclick="calculateResults()">Go to My Results</button>`;
    } else {
        html = `<p>Your profile is complete! You can review your answers or go directly to your report.</p>
                <div class="button-group"><button onclick="startQuestionnaire('review')">Review My Answers</button><button class="secondary-button" onclick="calculateResults()">Go to My Results</button></div>`;
    }
    contentEl.innerHTML = html;
}

function buildQuestionFlow(mode) {
    const baseFlow = questions.filter(q => {
        const isRetired = userAnswers['sDemo_stage'] === 'Retired';
        return isRetired ? (q.id !== 'careerPlanning' && q.section !== 'Work') : (q.id !== 'retirementPlanning');
    });
    if (mode === 'fresh' || mode === 'review') {
        questionFlow = baseFlow;
    } else if (mode === 'complete_missing') {
        questionFlow = baseFlow.filter(section => section.items.some((item, i) => {
            const qId = item.id ? `s${section.section}_${item.id}` : `s${section.section}_q${i}`;
            return !userAnswers[qId] || userAnswers[qId] === 'skipped';
        }));
    } else {
        questionFlow = baseFlow;
    }
}

window.startQuestionnaire = function(mode = 'fresh') {
    document.getElementById('intro-section').classList.add('hidden');
    document.getElementById('load-profile-options-section').classList.add('hidden');
    document.getElementById('questionnaire-section').classList.remove('hidden');
    document.getElementById('profile-display-name').textContent = `Taking test as: ${currentProfileName}`;
    currentSectionIndex = 0;
    buildQuestionFlow(mode);
    if (questionFlow.length === 0 && mode !== 'fresh') {
        alert("No sections to show. Taking you to results.");
        calculateResults();
        return;
    }
    loadSection(currentSectionIndex);
}

function loadSection(index) {
    const sectionData = questionFlow[index];
    const form = document.getElementById('unified-questionnaire');
    form.innerHTML = '';
    let tooltipHtml = sectionData.tooltip ? `<span class="tooltip" onclick="toggleTooltip(event)">i<span class="tooltiptext">${sectionData.tooltip}</span></span>` : '';
    let sectionHtml = `<div class="section-title"><h2>${sectionData.title}</h2>${tooltipHtml}</div>`;
    if (sectionData.disclaimer) {
        sectionHtml += sectionData.disclaimer;
        if (!['A', 'B'].includes(sectionData.section)) {
            sectionHtml += `<button type="button" class="secondary-button" onclick="skipSection()">Skip this Section</button>`;
        }
    }
    if (sectionData.instructions) sectionHtml += `<p>${sectionData.instructions}</p>`;
    sectionData.items.forEach((item, i) => {
        const qId = item.id ? `s${sectionData.section}_${item.id}` : `s${sectionData.section}_q${i}`;
        const scale = item.scale || sectionData.scale;
        const itemTooltip = item.tooltip ? `<span class="tooltip" onclick="toggleTooltip(event)">i<span class="tooltiptext">${item.tooltip}</span></span>` : '';
        sectionHtml += `<div class="question-group"><p class="question-text"><span>${item.text}</span> ${itemTooltip}</p>`;
        if (item.type === 'select') {
            sectionHtml += `<select name="${qId}" onchange="saveCurrentAnswers()">`;
            item.options.forEach(opt => {
                sectionHtml += `<option value="${opt}" ${userAnswers[qId] === opt ? 'selected' : ''}>${opt}</option>`;
            });
            sectionHtml += `</select></div>`;
        } else {
            sectionHtml += `<div class="options-group">`;
            scale.forEach((label, value) => {
                const radioVal = ['C', 'Health'].includes(sectionData.section) ? (value === 0 ? 1 : 0) : (value + 1);
                sectionHtml += `<label><input type="radio" name="${qId}" value="${radioVal}" required ${userAnswers[qId] == radioVal ? 'checked' : ''}> ${label}</label>`;
            });
            if (item.hasOther) {
                const otherId = `${qId}_other_text`;
                sectionHtml += `<input type="text" id="${otherId}" name="${otherId}" class="inline-input" placeholder="Please specify" value="${userAnswers[otherId] || ''}" style="margin-top: 10px; width: 100%;">`;
            }
            sectionHtml += `</div></div>`;
        }
    });
    form.innerHTML = sectionHtml;
    updateProgressBar();
    document.getElementById('prev-button').classList.toggle('hidden', index === 0);
    document.getElementById('next-button').textContent = (index === questionFlow.length - 1) ? 'Show My Results' : 'Next';
}

function saveCurrentAnswers() {
    const formData = new FormData(document.getElementById('unified-questionnaire'));
    for (let [key, value] of formData.entries()) { userAnswers[key] = value; }
    const otherInput = document.querySelector('input[id$="_other_text"]');
    if (otherInput) { userAnswers[otherInput.name] = otherInput.value; }
    const allProfiles = getAllProfiles();
    allProfiles[currentProfileName] = userAnswers;
    saveAllProfiles(allProfiles);
}

window.skipSection = function() {
    questionFlow[currentSectionIndex].items.forEach((item, i) => {
        userAnswers[item.id ? `s${questionFlow[currentSectionIndex].section}_${item.id}` : `s${questionFlow[currentSectionIndex].section}_q${i}`] = "skipped";
    });
    nextSection(true);
}

window.previousSection = function() {
    if (currentSectionIndex > 0) {
        saveCurrentAnswers();
        currentSectionIndex--;
        loadSection(currentSectionIndex);
    }
}

window.nextSection = function(isSkipping = false) {
    if (!isSkipping && !validateCurrentSection()) {
        document.getElementById('error-message').classList.remove('hidden');
        return;
    }
    document.getElementById('error-message').classList.add('hidden');
    saveCurrentAnswers();
    if (currentSectionIndex < questionFlow.length - 1) {
        currentSectionIndex++;
        loadSection(currentSectionIndex);
        window.scrollTo(0, 0);
    } else {
        calculateResults();
    }
}

function validateCurrentSection() {
    const form = document.getElementById('unified-questionnaire');
    const sectionData = questionFlow[currentSectionIndex];
    if (['A', 'B'].includes(sectionData.section)) {
        const radioGroups = {};
        form.querySelectorAll('input[type="radio"]').forEach(i => radioGroups[i.name] = i.checked || radioGroups[i.name]);
        return Object.values(radioGroups).every(v => v);
    }
    return true;
}

function updateProgressBar() {
    const progress = (currentSectionIndex / (questionFlow.length - 1)) * 100;
    document.getElementById('progress-bar').style.width = `${progress}%`;
}

window.calculateResults = function() {
    saveCurrentAnswers();
    document.getElementById('questionnaire-section').classList.add('hidden');
    document.getElementById('load-profile-options-section').classList.add('hidden');
    document.getElementById('results-container').classList.remove('hidden');
    document.getElementById('results-profile-name').textContent = currentProfileName;
    window.scrollTo(0, 0);
    const bigFiveScores = scoreBigFive();
    const viaStrengths = scoreViaStrengths();
    const aceScore = scoreACEs();
    const healthData = getHealthData();
    const archetype = determineArchetype(bigFiveScores);
    renderInfographic(bigFiveScores, viaStrengths, archetype);
    displayArchetype(archetype, viaStrengths);
    displayViaStrengthsResults(viaStrengths);
    displayACEResults(aceScore);
    displayHealthResults(healthData);
    displayAIGuidanceSection();
    displayFinalGuidance(bigFiveScores);
    document.getElementById('ai-context-education').value = userAnswers.contextEducation || '';
    document.getElementById('ai-context-interests').value = userAnswers.contextInterests || '';
    document.getElementById('ai-context-goals').value = userAnswers.contextGoals || '';
}

window.returnToIntro = function() {
    document.getElementById('results-container').classList.add('hidden');
    document.getElementById('load-profile-options-section').classList.add('hidden');
    document.getElementById('intro-section').classList.remove('hidden');
    initializeProfileView();
}

function scoreBigFive() {
    const scores = { O: 0, C: 0, E: 0, A: 0, N: 0 };
    const section = questions.find(q => q.section === 'A');
    if (!section) return scores;
    section.items.forEach((item, i) => {
        const val = parseInt(userAnswers[`sA_q${i}`]);
        if (!isNaN(val)) scores[item.trait] += item.reverse ? (6 - val) : val;
    });
    return scores;
}

function scoreViaStrengths() {
    const scores = [];
    const section = questions.find(q => q.section === 'B');
    if (!section) return scores;
    section.items.forEach((item, i) => {
        const score = parseInt(userAnswers[`sB_q${i}`]);
        if (!isNaN(score)) scores.push({ strength: item.strength, score });
    });
    return scores.sort((a, b) => b.score - a.score);
}

function scoreACEs() {
    let score = 0;
    const section = questions.find(q => q.section === 'C');
    if (!section) return "skipped";
    let skipped = section.items.some((item, i) => userAnswers[`sC_q${i}`] === "skipped");
    if (skipped) return "skipped";
    section.items.forEach((item, i) => { if (userAnswers[`sC_q${i}`] == 1) score++; });
    return score;
}

function getDemographics() { return { age: userAnswers['sDemo_age'], gender: userAnswers['sDemo_gender'], country: userAnswers['sDemo_country'], stage: userAnswers['sDemo_stage'] }; }

function getHealthData() {
    const data = {};
    const section = questions.find(q => q.section === 'Health');
    if (!section) return { summary: "Not answered", details: {} };
    let answered = false, skipped = false;
    section.items.forEach(item => {
        const qId = `sHealth_${item.id}`;
        if (userAnswers[qId] === 'skipped') { skipped = true; return; }
        if (userAnswers[qId] !== undefined) {
            answered = true;
            data[item.id] = userAnswers[qId] == 1 ? 'Yes' : 'No';
            if (item.hasOther && data[item.id] === 'Yes') data[`${item.id}_details`] = userAnswers[`${qId}_other_text`] || 'Not specified';
        }
    });
    if (skipped) return { summary: "Skipped", details: {} };
    if (!answered) return { summary: "Not answered", details: {} };
    return { summary: "Answered", details: data };
}

function getWorkPreferences() {
    return { environment: userAnswers['sWork_environment'], role: userAnswers['sWork_role'], driver: userAnswers['sWork_driver'] };
}
function getFinancialContext() {
    return { incomeUrgency: userAnswers['sD_incomeUrgency'], investmentTolerance: userAnswers['sD_investmentTolerance'] };
}
function getRetirementContext() {
    return { hobbyBudget: userAnswers['sE_hobbyBudget'], activityLevel: userAnswers['sE_activityLevel'], socialNeed: userAnswers['sE_socialNeed'] };
}

function determineArchetype(scores) {
    const sorted = Object.entries(scores).sort(([, a], [, b]) => b - a);
    const p = sorted[0][0], s = sorted[1][0];
    const archetypes = { O: { C: { t: "The Architect", d: "Visionary mind, disciplined execution." }, E: { t: "The Pioneer", d: "Outgoing explorer of new ideas." }, A: { t: "The Visionary", d: "Imaginative and compassionate." }, default: { t: "The Explorer", d: "Driven by curiosity and novelty." } }, C: { O: { t: "The Architect", d: "Visionary mind, disciplined execution." }, E: { t: "The Organizer", d: "Reliable and sociable leader." }, A: { t: "The Guardian", d: "Dependable pillar of the community." }, default: { t: "The Sentinel", d: "Bedrock of reliability and order." } }, E: { O: { t: "The Pioneer", d: "Outgoing explorer of new ideas." }, C: { t: "The Organizer", d: "Reliable and sociable leader." }, A: { t: "The Diplomat", d: "People-person, excels at harmony." }, default: { t: "The Ambassador", d: "Energized by social interaction." } }, A: { O: { t: "The Visionary", d: "Imaginative and compassionate." }, C: { t: "The Guardian", d: "Dependable pillar of the community." }, E: { t: "The Diplomat", d: "People-person, excels at harmony." }, default: { t: "The Harmonizer", d: "Driven by compassion and cooperation." } } };
    const def = { title: "The Analyst", desc: "Thoughtful and introspective." };
    const group = archetypes[p];
    if (!group) return def;
    const specific = group[s];
    return specific ? { title: specific.t, desc: specific.d } : { title: group.default.t, desc: group.default.d };
}

function displayArchetype(archetype, strengths) {
    const top = strengths.length > 0 ? strengths[0].strength : 'your unique talents';
    document.getElementById('archetype-section').innerHTML = `<h3>Your Personality Archetype</h3><h4 class="archetype-title">${archetype.title}</h4><p>${archetype.desc} You likely express this through your signature strength of <strong>${top}</strong>.</p>`;
}
function displayViaStrengthsResults(strengths) {
    let html = `<h3>Your Top 5 Character Strengths</h3>`;
    if (strengths.length > 0) {
        html += `<ul>${strengths.slice(0, 5).map(s => `<li><strong>${s.strength}</strong></li>`).join('')}</ul>`;
    } else { html += `<p>No strengths data to display.</p>`; }
    html += `<p>Focusing on using these strengths in new ways is a proven path to greater well-being and success.</p>`;
    document.getElementById('via-strengths-results').innerHTML = html;
}
function displayACEResults(score) {
    let html = `<h3>Upbringing & Life Experiences (ACEs)</h3>`;
    if (score === "skipped") { html += `<p>You chose to skip this section.</p>`; }
    else { html += `<p>Your ACE score is <strong>${score} out of 10</strong>.</p><div class="disclaimer"><h4>Understanding Your ACE Score</h4><p>An ACE score is a research tool, <strong>not a diagnosis of your destiny.</strong> A higher score shows a statistical link to certain health risks, but many with high scores lead healthy, fulfilling lives. <strong>Awareness is power.</strong></p><h4>Mental Health Resources in India</h4><ul class="resource-list"><li><strong>iCALL Psychosocial Helpline:</strong> Run by TISS.</li><li><strong>Vandrevala Foundation:</strong> 24/7 crisis hotline.</li><li><strong>The Live Love Laugh Foundation:</strong> Resources and directories.</li></ul></div>`; }
    document.getElementById('ace-results').innerHTML = html;
}
function displayHealthResults(healthData) {
    let html = `<h3>Health & Abilities</h3>`;
    if (healthData.summary === "Skipped") { html += `<p>You chose to skip this section.</p>`; }
    else if (healthData.summary === "Not answered") { html += `<p>This optional section was not answered.</p>`; }
    else {
        html += `<p>This summary reflects your provided information to help tailor AI suggestions.</p><ul>`;
        const labels = { mobility: "Mobility Impairment", chronic: "Chronic Condition", sensory: "Sensory Impairment", neuro: "Neuro/Mental Health", other: "Other Condition" };
        let reported = false;
        for (const key in healthData.details) {
            if (healthData.details[key] === 'Yes') {
                reported = true;
                html += `<li><strong>${labels[key]}:</strong> Yes${key === 'other' && healthData.details.other_details ? ` (${healthData.details.other_details})` : ''}</li>`;
            }
        }
        if (!reported) html += `<li>No specific conditions reported.</li>`;
        html += `</ul>`;
    }
    document.getElementById('health-results').innerHTML = html;
}
function displayAIGuidanceSection() {
    const retired = getDemographics().stage === 'Retired';
    const html = `<h3>${retired ? "Get AI-Powered Retirement Guidance" : "Get Your AI-Powered Career Guidance"}</h3>
        <p>${retired ? "Get a personalized narrative from an AI life coach." : "Get a personalized narrative from an AI career counselor."}</p>
        <h4>Instructions</h4><ol><li><strong>Add Context (Optional):</strong> Fill in the fields below.</li><li><strong>Get Guidance:</strong> Click "Prepare & Copy Prompt", then paste it into an AI.</li></ol>
        <h4>Step 1: Add Your Context</h4>
        <label for="ai-context-education">Current/Former Profession or Field:</label><input type="text" id="ai-context-education" placeholder="e.g., Retired Teacher, Software Engineer" oninput="saveContextData()">
        <label for="ai-context-interests">${retired ? "Passions or things you've wanted to try?" : "Subjects or Activities You Enjoy:"}</label><textarea id="ai-context-interests" rows="2" placeholder="e.g., History, gardening" oninput="saveContextData()"></textarea>
        <label for="ai-context-goals">${retired ? "What's most important in your retirement activities?" : "What are the most important factors in a career?"}</label><textarea id="ai-context-goals" rows="2" placeholder="${retired ? "e.g., Staying mentally sharp, giving back" : "e.g., Work-life balance, helping people"}" oninput="saveContextData()"></textarea>
        <h4>Step 2: Get Guidance</h4>
        <div class="ai-button-group"><button onclick="prepareAndCopyAIPrompt(this)">Prepare & Copy Prompt</button><a href="https://gemini.google.com" target="_blank" rel="noopener noreferrer" style="text-decoration: none;"><button type="button" class="secondary-button">Open Gemini</button></a><div id="copy-tooltip">Copied!</div></div>
        <p class="ai-disclaimer"><strong>Disclaimer:</strong> You are responsible for data you share with AI services. This is for informational purposes only.</p>`;
    document.getElementById('ai-guidance-section').innerHTML = html;
}
function displayFinalGuidance(scores) {
    let html = `<h3>Final Guidance & Areas for Growth</h3>`;
    if (scores.N > 35) html += `<p><strong>Managing Emotional Sensitivity:</strong> Your high Neuroticism score suggests you may be more susceptible to stress. This can be a source of empathy, but it's crucial to develop healthy coping mechanisms like mindfulness or professional support.</p>`;
    else html += `<p><strong>Emotional Resilience:</strong> Your results suggest good emotional stability. Continue to cultivate healthy coping strategies for life's challenges.</p>`;
    if (scores.C < 25) html += `<p><strong>Developing Structure:</strong> Your lower Conscientiousness score might mean challenges with organization. While spontaneity is a strength, building small, consistent habits can help you achieve long-term goals.</p>`;
    html += `<p>Remember, this is a snapshot to aid your journey. True growth comes from applying these insights.</p>`;
    document.getElementById('final-guidance').innerHTML = html;
}

function copyTextToClipboardFallback(text) {
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position = "fixed";
    ta.style.top = 0;
    ta.style.left = 0;
    document.body.appendChild(ta);
    ta.focus(); ta.select();
    let success = false;
    try { success = document.execCommand('copy'); } catch (err) {}
    document.body.removeChild(ta);
    return success;
}

window.saveContextData = function() {
    if (!currentProfileName) return;
    userAnswers.contextEducation = document.getElementById('ai-context-education').value;
    userAnswers.contextInterests = document.getElementById('ai-context-interests').value;
    userAnswers.contextGoals = document.getElementById('ai-context-goals').value;
    const allProfiles = getAllProfiles();
    allProfiles[currentProfileName] = userAnswers;
    saveAllProfiles(allProfiles);
}

window.prepareAndCopyAIPrompt = function(buttonElement) {
    const isRetired = getDemographics().stage === 'Retired';
    const textToCopy = isRetired ? prepareRetiredPrompt() : prepareCareerPrompt();
    if (copyTextToClipboardFallback(textToCopy)) {
        const tooltip = buttonElement.parentElement.querySelector('#copy-tooltip');
        tooltip.classList.add('show');
        setTimeout(() => { tooltip.classList.remove('show'); }, 2000);
    } else { alert("Failed to copy text."); }
}

function getInfographicAsText() {
    const scores = scoreBigFive();
    const strengths = scoreViaStrengths().slice(0, 5).map(s => s.strength);
    const archetype = determineArchetype(scores);
    let text = `**PERSONAL PROFILE SNAPSHOT**\n\n**ARCHETYPE: The ${archetype.title}**\n${archetype.desc}\n\n**PERSONALITY SPECTRUM (Scores out of 50):**\n`;
    const traitNames = {O: "Openness", C: "Conscientiousness", E: "Extraversion", A: "Agreeableness", N: "Neuroticism"};
    for (const trait in scores) { text += `- ${traitNames[trait]}: ${scores[trait]}\n`; }
    text += `\n**TOP STRENGTHS:**\n- ${strengths.join('\n- ')}`;
    return text;
}

function prepareCareerPrompt() {
    const d = getDemographics(), w = getWorkPreferences(), h = getHealthData(), a = scoreACEs(), f = getFinancialContext(), i = getInfographicAsText();
    const lang = localStorage.getItem('selectedLanguage') || 'en';
    return `You are an expert career counselor. Your task is to provide an insightful and encouraging analysis in ${languages[lang] || 'English'}.
Response Structure: 1. Reproduce the snapshot below. 2. Detailed analysis of archetype, experiences, career paths, and growth areas. 3. Conclude with "Your Journey Continues" and ask a simple, exploratory question.
---
${i}
---
USER DATA: Name: ${currentProfileName}, Demo: ${d.age}, ${d.gender}, ${d.country}, ${d.stage}. ACE: ${a}. Work Prefs: ${w.environment}, ${w.role}, ${w.driver}. Financial: ${f.incomeUrgency}, ${f.investmentTolerance}. Health: ${JSON.stringify(h.details)}. Context: ${userAnswers.contextEducation}, ${userAnswers.contextInterests}, ${userAnswers.contextGoals}.
--- END ---`;
}

function prepareRetiredPrompt() {
    const d = getDemographics(), r = getRetirementContext(), h = getHealthData(), a = scoreACEs(), i = getInfographicAsText();
    const lang = localStorage.getItem('selectedLanguage') || 'en';
    return `You are an expert retirement life coach. Your task is to provide an insightful and encouraging analysis in ${languages[lang] || 'English'}.
Response Structure: 1. Reproduce the snapshot below. 2. Detailed analysis of archetype, experiences, activity suggestions, and retirement opportunities. 3. Conclude with "Your Journey Continues" and ask a simple, exploratory question.
---
${i}
---
USER DATA: Name: ${currentProfileName}, Demo: ${d.age}, ${d.gender}, ${d.country}, ${d.stage}. ACE: ${a}. Retirement Prefs: ${r.hobbyBudget}, ${r.activityLevel}, ${r.socialNeed}. Health: ${JSON.stringify(h.details)}. Context: ${userAnswers.contextEducation}, ${userAnswers.contextInterests}, ${userAnswers.contextGoals}.
--- END ---`;
}

function renderInfographic(scores, strengths, archetype) {
    const container = document.getElementById('infographic-container');
    const interp = { O: { n: "Openness", h: "Creative, curious", l: "Practical, routine" }, C: { n: "Conscientiousness", h: "Organized, disciplined", l: "Spontaneous, flexible" }, E: { n: "Extraversion", h: "Outgoing, sociable", l: "Solitary, reserved" }, A: { n: "Agreeableness", h: "Compassionate, cooperative", l: "Competitive, critical" }, N: { n: "Neuroticism", h: "Emotionally sensitive", l: "Emotionally stable" } };
    const colors = { O: '#3b82f6', C: '#10b981', E: '#f97316', A: '#8b5cf6', N: '#ef4444' };
    let fiveHtml = Object.entries(scores).map(([t, s]) => {
        const p = (s / 50) * 100;
        const d = s >= 30 ? interp[t].h : s <= 20 ? interp[t].l : "Balanced.";
        return `<div class="bar-item"><div class="bar-label"><span>${interp[t].n}</span><span>${s}/50</span></div><div class="bar-background"><div class="bar-foreground" style="width:${p}%;background-color:${colors[t]};"></div></div><div class="trait-interpretation">${d}</div></div>`;
    }).join('');
    let strHtml = `<ul class="strengths-list">${strengths.slice(0, 5).map(s => `<li>${s.strength}</li>`).join('')}</ul>`;
    container.innerHTML = `<h3 class="infographic-title">Your Personal Profile Snapshot</h3><div class="infographic-grid"><div><h4 class="infographic-section-title">Personality Spectrum</h4><div class="bar-chart-container">${fiveHtml}</div></div><div><h4 class="infographic-section-title">Top Strengths</h4>${strHtml}<h4 class="infographic-section-title" style="margin-top:20px">Your Archetype</h4><div class="archetype-infographic-box"><h5>The ${archetype.title}</h5><p>${archetype.desc}</p></div></div></div>`;
    container.classList.remove('hidden');
}

window.toggleTooltip = function(event) {
    event.stopPropagation();
    event.currentTarget.classList.toggle('active');
}

// --- Initial Execution ---
document.addEventListener('DOMContentLoaded', () => {
    initializeTheme();
    populateLanguageSelector();

    // Show language modal on first visit if no language is set, and default to English.
    if (!localStorage.getItem('selectedLanguage')) {
        localStorage.setItem('selectedLanguage', 'en');
        toggleLanguageModal();
    }

    // Event Listeners
    document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
    document.getElementById('language-toggle').addEventListener('click', toggleLanguageModal);
    document.getElementById('language-modal-overlay').addEventListener('click', function(e) {
        if (e.target === this) {
            toggleLanguageModal();
        }
    });
    
    const aboutButton = document.getElementById('about-button');
    const aboutContent = document.getElementById('about-content');
    aboutButton.addEventListener('click', () => {
        const isHidden = aboutContent.classList.toggle('hidden');
        aboutButton.textContent = isHidden ? 'About this Tool' : 'Show Less';
    });
    
    initializeProfileView();
});

})();
</script>
<!-- OPTIMIZATION: Moved Google Translate script to the end of the body and added async/defer -->
<script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit" async defer></script>

<script>
function changeLanguage(lang) {
    const interval = setInterval(() => {
        const select = document.querySelector(".goog-te-combo");
        if (select) {
            select.value = lang;
            select.dispatchEvent(new Event("change"));
            clearInterval(interval);
        }
    }, 100);
}
</script>
</body>
</html>
